@page "/my-images"
@using LoraMint.Web.Models
@using System.Text.Json.Serialization
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>My Images</PageTitle>

<RadzenText TextStyle="TextStyle.H2" Style="margin-bottom: 1.5rem;">My Images</RadzenText>

<RadzenStack Gap="1rem">
    <RadzenFormField Text="User ID">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenTextBox @bind-Value="userId" Placeholder="Enter your user ID" Style="flex: 1;" />
            <RadzenButton Text="Load Images" Icon="refresh" ButtonStyle="ButtonStyle.Primary" Click="@LoadImages" />
        </RadzenStack>
    </RadzenFormField>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
            @errorMessage
        </RadzenAlert>
    }

    @if (isLoading)
    {
        <div style="text-align: center; padding: 2rem;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </div>
    }
    else if (images.Any())
    {
        <RadzenRow Gap="1.5rem">
            @foreach (var image in images)
            {
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenCard Style="height: 100%;">
                        <RadzenImage Path="@image.Url" Style="width: 100%; height: auto; border-radius: 4px; margin-bottom: 0.75rem;" AlternateText="@image.FileName" />
                        <RadzenText TextStyle="TextStyle.H6" Style="margin-bottom: 0.5rem;">@image.FileName</RadzenText>
                        @if (!string.IsNullOrEmpty(image.Prompt))
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin-bottom: 0.5rem;">@image.Prompt</RadzenText>
                        }
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">@image.CreatedAt.ToString("g")</RadzenText>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
            No images found. Generate some images first!
        </RadzenAlert>
    }
</RadzenStack>

@code {
    private string userId = "user123"; // Default for testing
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private List<ImageInfo> images = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadImages();
    }

    private async Task LoadImages()
    {
        errorMessage = string.Empty;
        isLoading = true;

        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse>($"/api/images/{userId}");
            if (response?.Success == true && response.Images != null)
            {
                images = response.Images;
            }
            else
            {
                errorMessage = response?.Error ?? "Failed to load images";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private class ApiResponse
    {
        [JsonPropertyName("success")]
        public bool Success { get; set; }

        [JsonPropertyName("images")]
        public List<ImageInfo>? Images { get; set; }

        [JsonPropertyName("error")]
        public string? Error { get; set; }
    }
}
