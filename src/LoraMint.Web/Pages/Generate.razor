@page "/generate"
@using LoraMint.Web.Models
@using LoraMint.Web.Services
@using Microsoft.JSInterop
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>Generate Image</PageTitle>

<RadzenText TextStyle="TextStyle.H2" Style="margin-bottom: 1.5rem;">Generate Image</RadzenText>

<RadzenRow Gap="1.5rem">
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Prompt">
                    <RadzenTextArea @bind-Value="prompt" Rows="4"
                        Placeholder="Describe the image you want to generate..."
                        Style="width: 100%;"
                        Disabled="@isGenerating" />
                </RadzenFormField>

                <RadzenFormField Text="User ID">
                    <RadzenTextBox @bind-Value="userId"
                        Placeholder="Enter your user ID"
                        Style="width: 100%;"
                        Disabled="@isGenerating" />
                </RadzenFormField>

                <RadzenFormField Text="Select LoRAs (Optional)">
                    @if (availableLoras.Any())
                    {
                        <RadzenStack Gap="0.5rem">
                            @foreach (var lora in availableLoras)
                            {
                                <RadzenCheckBox @bind-Value="@selectedLorasDict[lora.FileName]"
                                               Name="@lora.FileName"
                                               Disabled="@isGenerating"
                                               Change="@((bool value) => ToggleLora(lora.FileName, value))" />
                                <RadzenLabel Text="@lora.Name" Component="@lora.FileName" Style="margin-left: 0.25rem;" />
                            }
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">No LoRAs available. Train one first!</RadzenText>
                    }
                </RadzenFormField>

                @* Progress Section *@
                @if (isGenerating)
                {
                    <RadzenCard Style="background: var(--rz-base-800); padding: 1rem;">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 500;">
                                @progressMessage
                            </RadzenText>
                            <RadzenProgressBar Value="@progressPercentage"
                                ShowValue="true"
                                Style="height: 24px;"
                                ProgressBarStyle="ProgressBarStyle.Primary" />
                            <RadzenText TextStyle="TextStyle.Caption"
                                Style="color: var(--rz-text-secondary-color);">
                                Step @currentStep of @totalSteps
                            </RadzenText>
                        </RadzenStack>
                    </RadzenCard>
                }

                <RadzenButton Text="@(isGenerating ? "Generating..." : "Generate Image")"
                             Icon="@(isGenerating ? "" : "add_photo_alternate")"
                             IsBusy="@isGenerating"
                             ButtonStyle="ButtonStyle.Primary"
                             Click="@GenerateImageWithProgress"
                             Disabled="@isGenerating" />

                <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-tertiary-color); margin-top: 0.5rem;">
                    Powered by Stable Diffusion XL
                </RadzenText>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @errorMessage
                    </RadzenAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @successMessage
                    </RadzenAlert>
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        @if (!string.IsNullOrEmpty(generatedImagePath))
        {
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H5" Style="margin-bottom: 1rem;">Generated Image</RadzenText>
                <RadzenImage Path="@generatedImagePath" Style="width: 100%; height: auto;" AlternateText="Generated image" />
            </RadzenCard>
        }
    </RadzenColumn>
</RadzenRow>

@code {
    private string prompt = string.Empty;
    private string userId = "user123"; // Default for testing
    private bool isGenerating = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string generatedImagePath = string.Empty;
    private List<LoraInfo> availableLoras = new();
    private Dictionary<string, double> selectedLoras = new();
    private Dictionary<string, bool> selectedLorasDict = new();

    // Progress tracking fields
    private double progressPercentage = 0;
    private int currentStep = 0;
    private int totalSteps = 30;
    private string progressMessage = "Starting generation...";

    // JS interop reference
    private DotNetObjectReference<Generate>? dotNetHelper;

    protected override async Task OnInitializedAsync()
    {
        await LoadLoras();
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    private async Task LoadLoras()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<LoraInfo>>>($"/api/loras/{userId}");
            if (response?.Success == true && response.Loras != null)
            {
                availableLoras = response.Loras;
                // Initialize checkbox state
                foreach (var lora in availableLoras)
                {
                    selectedLorasDict[lora.FileName] = false;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load LoRAs: {ex.Message}";
        }
    }

    private void ToggleLora(string fileName, bool isSelected)
    {
        if (isSelected)
        {
            selectedLoras[fileName] = 1.0; // Default strength
        }
        else
        {
            selectedLoras.Remove(fileName);
        }
    }

    private async Task GenerateImageWithProgress()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        generatedImagePath = string.Empty;
        progressPercentage = 0;
        currentStep = 0;
        totalSteps = 30;
        progressMessage = "Initializing...";

        if (string.IsNullOrWhiteSpace(prompt))
        {
            errorMessage = "Please enter a prompt";
            return;
        }

        isGenerating = true;
        StateHasChanged();

        try
        {
            var request = new GenerateRequest
            {
                Prompt = prompt,
                UserId = userId,
                Loras = selectedLoras.Select(kvp => new LoraReference
                {
                    File = kvp.Key,
                    Strength = kvp.Value
                }).ToList()
            };

            // Start SSE connection via JavaScript
            await JS.InvokeVoidAsync(
                "SseClient.startGeneration",
                "/api/generate/stream",
                request,
                dotNetHelper
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            isGenerating = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Called by JavaScript when a progress event is received from SSE
    /// </summary>
    [JSInvokable]
    public async Task OnProgressEvent(SseProgressEvent evt)
    {
        switch (evt.Event)
        {
            case "progress":
                currentStep = evt.Step ?? 0;
                totalSteps = evt.TotalSteps ?? 30;
                progressPercentage = evt.Percentage ?? 0;
                progressMessage = evt.Message ?? "Generating...";
                break;

            case "complete":
                generatedImagePath = evt.ImagePath ?? string.Empty;
                successMessage = evt.Message ?? "Image generated successfully!";
                progressPercentage = 100;
                progressMessage = "Complete!";
                currentStep = totalSteps;
                isGenerating = false;
                break;

            case "error":
                errorMessage = evt.Error ?? "An error occurred during generation";
                isGenerating = false;
                break;
        }

        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Called by JavaScript when a connection error occurs
    /// </summary>
    [JSInvokable]
    public async Task OnError(string message)
    {
        errorMessage = $"Connection error: {message}";
        isGenerating = false;
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("SseClient.stopGeneration");
        }
        catch
        {
            // Ignore errors during disposal
        }
        dotNetHelper?.Dispose();
    }

    private class ApiResponse<T>
    {
        public bool Success { get; set; }
        public T? Loras { get; set; }
        public T? ImageData { get; set; }
        public string? Error { get; set; }
    }
}
