@page "/generate"
@using LoraMint.Web.Models
@using LoraMint.Web.Services
@using Microsoft.JSInterop
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>Generate Image</PageTitle>

<style>
    .dots-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .pulse-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        animation: pulse-animation 1.4s ease-in-out infinite;
    }

    .pulse-dot:nth-child(1) {
        background: #8b5cf6;
        box-shadow: 0 0 12px #8b5cf6;
        animation-delay: 0s;
    }

    .pulse-dot:nth-child(2) {
        background: #ec4899;
        box-shadow: 0 0 12px #ec4899;
        animation-delay: 0.2s;
    }

    .pulse-dot:nth-child(3) {
        background: #f97316;
        box-shadow: 0 0 12px #f97316;
        animation-delay: 0.4s;
    }

    @@keyframes pulse-animation {
        0%, 80%, 100% {
            transform: scale(0.6);
            opacity: 0.5;
        }
        40% {
            transform: scale(1.3);
            opacity: 1;
        }
    }

    .spin-ring {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        position: relative;
        margin: 1rem auto;
    }

    .spin-ring::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 50%;
        border: 3px solid transparent;
        border-top-color: #8b5cf6;
        border-right-color: #ec4899;
        animation: spin-anim 1s linear infinite;
    }

    .spin-ring::after {
        content: '';
        position: absolute;
        inset: 8px;
        border-radius: 50%;
        border: 2px solid transparent;
        border-bottom-color: #f97316;
        border-left-color: #22d3ee;
        animation: spin-anim 1.5s linear infinite reverse;
    }

    @@keyframes spin-anim {
        to { transform: rotate(360deg); }
    }

    .step-display {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.75rem;
        font-weight: 600;
        color: #22d3ee;
        text-shadow: 0 0 20px #22d3ee;
    }
</style>

<RadzenText TextStyle="TextStyle.H2" Style="margin-bottom: 1.5rem;">Generate Image</RadzenText>

<RadzenRow Gap="1.5rem">
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Prompt">
                    <RadzenTextArea @bind-Value="prompt" Rows="4"
                        Placeholder="Describe the image you want to generate..."
                        Style="width: 100%;"
                        Disabled="@isGenerating" />
                </RadzenFormField>

                <RadzenFormField Text="User ID">
                    <RadzenTextBox @bind-Value="userId"
                        Placeholder="Enter your user ID"
                        Style="width: 100%;"
                        Disabled="@isGenerating" />
                </RadzenFormField>

                <RadzenFormField Text="Select LoRAs (Optional)">
                    @if (availableLoras.Any())
                    {
                        <RadzenStack Gap="0.5rem">
                            @foreach (var lora in availableLoras)
                            {
                                <RadzenCheckBox @bind-Value="@selectedLorasDict[lora.FileName]"
                                               Name="@lora.FileName"
                                               Disabled="@isGenerating"
                                               Change="@((bool value) => ToggleLora(lora.FileName, value))" />
                                <RadzenLabel Text="@lora.Name" Component="@lora.FileName" Style="margin-left: 0.25rem;" />
                            }
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--text-secondary);">No LoRAs available. Train one first!</RadzenText>
                    }
                </RadzenFormField>

                @* Generation Loading State *@
                @if (isGenerating)
                {
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.08)); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 2rem; text-align: center;">
                        @* Step Counter *@
                        <div style="margin-bottom: 1rem;">
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #a0a0b0; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Processing Step</div>
                            <div class="step-display">@currentStep / @totalSteps</div>
                        </div>

                        @* Spinning Ring *@
                        <div class="spin-ring"></div>

                        @* Loading Dots *@
                        <div class="dots-container" style="margin: 1.5rem 0;">
                            <div class="pulse-dot"></div>
                            <div class="pulse-dot"></div>
                            <div class="pulse-dot"></div>
                        </div>

                        @* Progress Message *@
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #f0f0f5; margin-bottom: 1rem;">@progressMessage</div>

                        @* Progress Bar *@
                        <div style="max-width: 300px; margin: 0 auto;">
                            <RadzenProgressBar Value="@progressPercentage"
                                ShowValue="true"
                                Style="height: 8px;"
                                ProgressBarStyle="ProgressBarStyle.Primary" />
                        </div>
                    </div>
                }
                else
                {
                    @* Generate Button - Only shown when not generating *@
                    <RadzenButton Text="./generate --execute"
                                 Icon="add_photo_alternate"
                                 ButtonStyle="ButtonStyle.Primary"
                                 Click="@GenerateImageWithProgress"
                                 Style="width: 100%; padding: 1rem; font-size: 1rem;" />
                }

                <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--text-muted); margin-top: 0.5rem; font-family: var(--font-mono);">
                    // Powered by Stable Diffusion XL
                </RadzenText>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @errorMessage
                    </RadzenAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @successMessage
                    </RadzenAlert>
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        @if (!string.IsNullOrEmpty(generatedImagePath))
        {
            <RadzenCard>
                <h5 class="digital-title" style="margin-bottom: 1rem; font-size: 1rem;">Output</h5>
                <RadzenImage Path="@generatedImagePath" Style="width: 100%; height: auto; border-radius: 8px;" AlternateText="Generated image" />
            </RadzenCard>
        }
        else if (isGenerating)
        {
            <RadzenCard Style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center;">
                    <div class="dots-container" style="margin-bottom: 1rem;">
                        <div class="pulse-dot"></div>
                        <div class="pulse-dot"></div>
                        <div class="pulse-dot"></div>
                    </div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #606070;">
                        Rendering output...
                    </div>
                </div>
            </RadzenCard>
        }
    </RadzenColumn>
</RadzenRow>

@code {
    private string prompt = string.Empty;
    private string userId = "user123"; // Default for testing
    private bool isGenerating = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string generatedImagePath = string.Empty;
    private List<LoraInfo> availableLoras = new();
    private Dictionary<string, double> selectedLoras = new();
    private Dictionary<string, bool> selectedLorasDict = new();

    // Progress tracking fields
    private double progressPercentage = 0;
    private int currentStep = 0;
    private int totalSteps = 30;
    private string progressMessage = "Starting generation...";

    // JS interop reference
    private DotNetObjectReference<Generate>? dotNetHelper;

    protected override async Task OnInitializedAsync()
    {
        await LoadLoras();
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    private async Task LoadLoras()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<LoraInfo>>>($"/api/loras/{userId}");
            if (response?.Success == true && response.Loras != null)
            {
                availableLoras = response.Loras;
                // Initialize checkbox state
                foreach (var lora in availableLoras)
                {
                    selectedLorasDict[lora.FileName] = false;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load LoRAs: {ex.Message}";
        }
    }

    private void ToggleLora(string fileName, bool isSelected)
    {
        if (isSelected)
        {
            selectedLoras[fileName] = 1.0; // Default strength
        }
        else
        {
            selectedLoras.Remove(fileName);
        }
    }

    private async Task GenerateImageWithProgress()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        generatedImagePath = string.Empty;
        progressPercentage = 0;
        currentStep = 0;
        totalSteps = 30;
        progressMessage = "Initializing...";

        if (string.IsNullOrWhiteSpace(prompt))
        {
            errorMessage = "Please enter a prompt";
            return;
        }

        isGenerating = true;
        StateHasChanged();

        try
        {
            var request = new GenerateRequest
            {
                Prompt = prompt,
                UserId = userId,
                Loras = selectedLoras.Select(kvp => new LoraReference
                {
                    File = kvp.Key,
                    Strength = kvp.Value
                }).ToList()
            };

            // Start SSE connection via JavaScript
            await JS.InvokeVoidAsync(
                "SseClient.startGeneration",
                "/api/generate/stream",
                request,
                dotNetHelper
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            isGenerating = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Called by JavaScript when a progress event is received from SSE
    /// </summary>
    [JSInvokable]
    public async Task OnProgressEvent(SseProgressEvent evt)
    {
        switch (evt.Event)
        {
            case "progress":
                currentStep = evt.Step ?? 0;
                totalSteps = evt.TotalSteps ?? 30;
                progressPercentage = evt.Percentage ?? 0;
                progressMessage = evt.Message ?? "Generating...";
                break;

            case "complete":
                generatedImagePath = evt.ImagePath ?? string.Empty;
                successMessage = evt.Message ?? "Image generated successfully!";
                progressPercentage = 100;
                progressMessage = "Complete!";
                currentStep = totalSteps;
                isGenerating = false;
                break;

            case "error":
                errorMessage = evt.Error ?? "An error occurred during generation";
                isGenerating = false;
                break;
        }

        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Called by JavaScript when a connection error occurs
    /// </summary>
    [JSInvokable]
    public async Task OnError(string message)
    {
        errorMessage = $"Connection error: {message}";
        isGenerating = false;
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("SseClient.stopGeneration");
        }
        catch
        {
            // Ignore errors during disposal
        }
        dotNetHelper?.Dispose();
    }

    private class ApiResponse<T>
    {
        public bool Success { get; set; }
        public T? Loras { get; set; }
        public T? ImageData { get; set; }
        public string? Error { get; set; }
    }
}
