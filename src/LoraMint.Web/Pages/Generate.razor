@page "/generate"
@using LoraMint.Web.Models
@using LoraMint.Web.Services
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Generate Image</PageTitle>

<RadzenText TextStyle="TextStyle.H2" Style="margin-bottom: 1.5rem;">Generate Image</RadzenText>

<RadzenRow Gap="1.5rem">
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Prompt">
                    <RadzenTextArea @bind-Value="prompt" Rows="4" Placeholder="Describe the image you want to generate..." Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="User ID">
                    <RadzenTextBox @bind-Value="userId" Placeholder="Enter your user ID" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Select LoRAs (Optional)">
                    @if (availableLoras.Any())
                    {
                        <RadzenStack Gap="0.5rem">
                            @foreach (var lora in availableLoras)
                            {
                                <RadzenCheckBox @bind-Value="@selectedLorasDict[lora.FileName]"
                                               Name="@lora.FileName"
                                               Change="@((bool value) => ToggleLora(lora.FileName, value))" />
                                <RadzenLabel Text="@lora.Name" Component="@lora.FileName" Style="margin-left: 0.25rem;" />
                            }
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">No LoRAs available. Train one first!</RadzenText>
                    }
                </RadzenFormField>

                <RadzenButton Text="@(isGenerating ? "Generating..." : "Generate Image")"
                             Icon="@(isGenerating ? "" : "add_photo_alternate")"
                             IsBusy="@isGenerating"
                             ButtonStyle="ButtonStyle.Primary"
                             Click="@GenerateImage"
                             Disabled="@isGenerating" />

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @errorMessage
                    </RadzenAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @successMessage
                    </RadzenAlert>
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        @if (!string.IsNullOrEmpty(generatedImagePath))
        {
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H5" Style="margin-bottom: 1rem;">Generated Image</RadzenText>
                <RadzenImage Path="@generatedImagePath" Style="width: 100%; height: auto;" AlternateText="Generated image" />
            </RadzenCard>
        }
    </RadzenColumn>
</RadzenRow>

@code {
    private string prompt = string.Empty;
    private string userId = "user123"; // Default for testing
    private bool isGenerating = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string generatedImagePath = string.Empty;
    private List<LoraInfo> availableLoras = new();
    private Dictionary<string, double> selectedLoras = new();
    private Dictionary<string, bool> selectedLorasDict = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLoras();
    }

    private async Task LoadLoras()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<LoraInfo>>>($"/api/loras/{userId}");
            if (response?.Success == true && response.Loras != null)
            {
                availableLoras = response.Loras;
                // Initialize checkbox state
                foreach (var lora in availableLoras)
                {
                    selectedLorasDict[lora.FileName] = false;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load LoRAs: {ex.Message}";
        }
    }

    private void ToggleLora(string fileName, bool isSelected)
    {
        if (isSelected)
        {
            selectedLoras[fileName] = 1.0; // Default strength
        }
        else
        {
            selectedLoras.Remove(fileName);
        }
    }

    private async Task GenerateImage()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(prompt))
        {
            errorMessage = "Please enter a prompt";
            return;
        }

        isGenerating = true;

        try
        {
            var request = new GenerateRequest
            {
                Prompt = prompt,
                UserId = userId,
                Loras = selectedLoras.Select(kvp => new LoraReference
                {
                    File = kvp.Key,
                    Strength = kvp.Value
                }).ToList()
            };

            var response = await Http.PostAsJsonAsync("/api/generate", request);
            var result = await response.Content.ReadFromJsonAsync<ApiResponse<string>>();

            if (result?.Success == true)
            {
                generatedImagePath = result.ImageData ?? string.Empty;
                successMessage = "Image generated successfully!";
            }
            else
            {
                errorMessage = result?.Error ?? "Failed to generate image";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private class ApiResponse<T>
    {
        public bool Success { get; set; }
        public T? Loras { get; set; }
        public T? ImageData { get; set; }
        public string? Error { get; set; }
    }
}
