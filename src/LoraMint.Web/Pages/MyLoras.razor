@page "/my-loras"
@using LoraMint.Web.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>My LoRAs</PageTitle>

<RadzenText TextStyle="TextStyle.H2" Style="margin-bottom: 1.5rem;">My LoRAs</RadzenText>

<RadzenStack Gap="1rem">
    <RadzenFormField Text="User ID">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenTextBox @bind-Value="userId" Placeholder="Enter your user ID" Style="flex: 1;" />
            <RadzenButton Text="Load LoRAs" Icon="refresh" ButtonStyle="ButtonStyle.Primary" Click="@LoadLoras" />
        </RadzenStack>
    </RadzenFormField>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
            @errorMessage
        </RadzenAlert>
    }

    @if (isLoading)
    {
        <div style="text-align: center; padding: 2rem;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </div>
    }
    else if (loras.Any())
    {
        <RadzenDataGrid Data="@loras" TItem="LoraInfo" AllowFiltering="true" AllowSorting="true" AllowPaging="true" PageSize="10">
            <Columns>
                <RadzenDataGridColumn TItem="LoraInfo" Property="Name" Title="Name" />
                <RadzenDataGridColumn TItem="LoraInfo" Property="FileName" Title="File Name" />
                <RadzenDataGridColumn TItem="LoraInfo" Property="FileSize" Title="Size">
                    <Template Context="lora">
                        @FormatFileSize(lora.FileSize)
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="LoraInfo" Property="CreatedAt" Title="Created" FormatString="{0:g}" />
                <RadzenDataGridColumn TItem="LoraInfo" Title="Actions" Sortable="false" Filterable="false">
                    <Template Context="lora">
                        <RadzenButton Text="Use in Generation" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary"
                                     Click="@(() => NavigationManager.NavigateTo("/generate"))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
            No LoRAs found. Train your first LoRA!
        </RadzenAlert>
    }
</RadzenStack>

@code {
    private string userId = "user123"; // Default for testing
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private List<LoraInfo> loras = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLoras();
    }

    private async Task LoadLoras()
    {
        errorMessage = string.Empty;
        isLoading = true;

        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse>($"/api/loras/{userId}");
            if (response?.Success == true && response.Loras != null)
            {
                loras = response.Loras;
            }
            else
            {
                errorMessage = response?.Error ?? "Failed to load LoRAs";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private class ApiResponse
    {
        public bool Success { get; set; }
        public List<LoraInfo>? Loras { get; set; }
        public string? Error { get; set; }
    }
}
