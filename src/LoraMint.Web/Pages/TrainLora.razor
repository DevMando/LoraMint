@page "/train-lora"
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Train LoRA</PageTitle>

<RadzenText TextStyle="TextStyle.H2" Style="margin-bottom: 1.5rem;">Train LoRA</RadzenText>

<RadzenRow Gap="1.5rem">
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="LoRA Name">
                    <RadzenTextBox @bind-Value="loraName" Placeholder="e.g., anime_style_v1" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="User ID">
                    <RadzenTextBox @bind-Value="userId" Placeholder="Enter your user ID" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Upload Reference Images (1-5 images)" Style="margin-bottom: 0;">
                    <InputFile OnChange="HandleFileSelection" multiple accept="image/*" class="rz-fileupload-choose" />
                    <RadzenText TextStyle="TextStyle.Caption" Style="display: block; margin-top: 0.25rem; color: var(--rz-text-secondary-color);">
                        Upload 1 to 5 reference images for training
                    </RadzenText>
                </RadzenFormField>

                @if (selectedFiles.Any())
                {
                    <div>
                        <RadzenText TextStyle="TextStyle.H6" Style="margin-bottom: 0.5rem;">Selected Files:</RadzenText>
                        <RadzenStack Gap="0.25rem">
                            @foreach (var file in selectedFiles)
                            {
                                <RadzenText>• @file.Name (@(file.Size / 1024) KB)</RadzenText>
                            }
                        </RadzenStack>
                    </div>
                }

                <RadzenButton Text="@(isTraining ? "Training..." : "Start Training")"
                             Icon="@(isTraining ? "" : "model_training")"
                             IsBusy="@isTraining"
                             ButtonStyle="ButtonStyle.Success"
                             Click="@StartTraining"
                             Disabled="@isTraining" />

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @errorMessage
                    </RadzenAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @successMessage
                    </RadzenAlert>
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H5" Style="margin-bottom: 1rem;">Training Tips</RadzenText>
            <RadzenStack Gap="0.5rem">
                <RadzenText>• Upload 1-5 high-quality reference images</RadzenText>
                <RadzenText>• Images should be clear and well-lit</RadzenText>
                <RadzenText>• Use consistent subject matter</RadzenText>
                <RadzenText>• Training may take several minutes</RadzenText>
                <RadzenText>• Name your LoRA descriptively</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private string loraName = string.Empty;
    private string userId = "user123"; // Default for testing
    private bool isTraining = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private List<IBrowserFile> selectedFiles = new();

    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFiles = e.GetMultipleFiles(5).ToList();
        errorMessage = string.Empty;

        if (selectedFiles.Count > 5)
        {
            errorMessage = "Maximum 5 files allowed";
            selectedFiles = selectedFiles.Take(5).ToList();
        }
    }

    private async Task StartTraining()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(loraName))
        {
            errorMessage = "Please enter a LoRA name";
            return;
        }

        if (!selectedFiles.Any())
        {
            errorMessage = "Please select at least one image";
            return;
        }

        isTraining = true;

        try
        {
            using var content = new MultipartFormDataContent();
            content.Add(new StringContent(loraName), "loraName");
            content.Add(new StringContent(userId), "userId");

            foreach (var file in selectedFiles)
            {
                var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)); // 10MB max
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
                content.Add(fileContent, "images", file.Name);
            }

            var response = await Http.PostAsync("/api/train-lora", content);
            var result = await response.Content.ReadFromJsonAsync<ApiResponse>();

            if (result?.Success == true)
            {
                successMessage = $"LoRA '{loraName}' trained successfully! Path: {result.Result}";
                loraName = string.Empty;
                selectedFiles.Clear();
            }
            else
            {
                errorMessage = result?.Error ?? "Failed to train LoRA";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isTraining = false;
        }
    }

    private class ApiResponse
    {
        public bool Success { get; set; }
        public string? Result { get; set; }
        public string? Error { get; set; }
    }
}
